{"version":3,"file":"background-3b0077a6.js","sources":["../../../src/background.ts"],"sourcesContent":["// 监听扩展安装事件\nchrome.runtime.onInstalled.addListener(() => {\n  console.log('Bookmark Manager Extension installed');\n  \n  // 创建右键菜单\n  chrome.contextMenus.create({\n    id: 'addBookmark',\n    title: '添加到收藏箱',\n    contexts: ['page', 'link']\n  }, () => {\n    console.log('右键菜单创建成功');\n    if (chrome.runtime.lastError) {\n      console.error('创建右键菜单出错:', chrome.runtime.lastError);\n    }\n  });\n  \n  // 创建添加收藏箱带预期时间的菜单\n  chrome.contextMenus.create({\n    id: 'addBookmarkWithDeadline',\n    title: '添加到收藏箱（设置预期查看时间）',\n    contexts: ['page', 'link']\n  }, () => {\n    console.log('带预期时间的右键菜单创建成功');\n    if (chrome.runtime.lastError) {\n      console.error('创建右键菜单出错:', chrome.runtime.lastError);\n    }\n  });\n  \n  // 初始化存储，确保有一个空的书签数组\n  chrome.storage.sync.get('bookmarks', (result) => {\n    if (!result.bookmarks) {\n      chrome.storage.sync.set({ bookmarks: [] }, () => {\n        console.log('初始化同步存储：创建空书签数组');\n      });\n    } else {\n      console.log('同步存储中已有书签数据:', result.bookmarks);\n    }\n  });\n});\n\n// 监听右键菜单点击事件\nchrome.contextMenus.onClicked.addListener((info, tab) => {\n  console.log('右键菜单被点击:', info.menuItemId);\n  \n  if (info.menuItemId === 'addBookmark') {\n    addBookmarkToStorage(info, tab);\n  } else if (info.menuItemId === 'addBookmarkWithDeadline') {\n    // 打开设置预期时间的弹窗\n    chrome.windows.create({\n      url: chrome.runtime.getURL('deadline-picker.html') + \n           `?url=${encodeURIComponent(info.linkUrl || info.pageUrl || '')}` + \n           `&title=${encodeURIComponent(tab?.title || '')}`,\n      type: 'popup',\n      width: 400,\n      height: 300\n    });\n  }\n});\n\ninterface BookmarkInfo {\n  linkUrl?: string;\n  pageUrl?: string;\n}\n\ninterface TabInfo {\n  title?: string;\n}\n\n// 添加书签到存储的公共函数\nfunction addBookmarkToStorage(info: BookmarkInfo, tab: TabInfo, expectedViewTime: number | null = null) {\n  const url = info.linkUrl || info.pageUrl || '';\n  const title = tab?.title || url;\n  \n  console.log('准备添加书签:', { title, url, expectedViewTime });\n  \n  // 保存书签到同步存储\n  chrome.storage.sync.get('bookmarks', (result) => {\n    // 确保 bookmarks 是数组\n    const bookmarks = Array.isArray(result.bookmarks) ? result.bookmarks : [];\n    \n    console.log('获取到的书签数据类型:', typeof result.bookmarks, Array.isArray(result.bookmarks));\n    \n    const newBookmark = {\n      id: Date.now().toString(),\n      title,\n      url,\n      addedTime: Date.now(),\n      expectedViewTime\n    };\n    \n    console.log('添加新书签:', newBookmark);\n    console.log('现有书签数量:', bookmarks.length);\n    \n    // 避免使用展开运算符，以防止潜在的迭代错误\n    const updatedBookmarks = bookmarks.concat([newBookmark]);\n    \n    chrome.storage.sync.set({\n      bookmarks: updatedBookmarks\n    }, () => {\n      console.log('书签保存成功到同步存储');\n      if (chrome.runtime.lastError) {\n        console.error('保存书签时出错:', chrome.runtime.lastError);\n      } else {\n        // 显示通知\n        chrome.notifications.create({\n          type: 'basic',\n          iconUrl: 'icons/icon128.png',\n          title: '书签已添加',\n          message: expectedViewTime \n            ? `\"${title}\" 已保存到收藏箱，预期查看时间：${new Date(expectedViewTime).toLocaleString()}` \n            : `\"${title}\" 已保存到收藏箱并同步到你的所有设备`,\n          priority: 2\n        });\n      }\n    });\n  });\n}\n\n// 监听来自预期时间设置页面的消息\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  if (message.action === 'addBookmarkWithDeadline') {\n    const { url, title, expectedViewTime } = message;\n    \n    // 使用模拟的 info 和 tab 对象\n    const info: BookmarkInfo = { linkUrl: url };\n    const tab: TabInfo = { title };\n    \n    addBookmarkToStorage(info, tab, expectedViewTime);\n    sendResponse({ success: true });\n  }\n});\n\n// 监听书签变化事件\nchrome.bookmarks.onCreated.addListener((id, bookmark) => {\n  console.log('Bookmark created:', bookmark);\n});\n\nchrome.bookmarks.onRemoved.addListener((id, removeInfo) => {\n  console.log('Bookmark removed:', removeInfo);\n});\n\nchrome.bookmarks.onChanged.addListener((id, changeInfo) => {\n  console.log('Bookmark changed:', changeInfo);\n});\n\n// 导出空对象以支持ES模块\nexport {}; "],"names":[],"mappings":"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"}